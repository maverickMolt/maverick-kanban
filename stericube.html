<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SteriCube Pipeline Tracker</title>
  <style>
    :root {
      --bg:#0f0f0f;--bg2:#151515;--surface:#1a1a1a;--surface2:#222;--border:#2a2a2a;--border2:#333;
      --orange:#ff9500;--orange-dim:rgba(255,149,0,.1);--text:#f0f0f0;--text-muted:#888;--text-dim:#555;
      --green:#30d158;--red:#ff453a;--blue:#0a84ff;--purple:#bf5af2;--yellow:#ffd60a;--teal:#32d2d2;--gray:#6e6e73;
      --font:-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;min-height:100vh}
    .header{background:var(--bg2);border-bottom:1px solid var(--border);padding:.875rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .header-left{display:flex;align-items:center;gap:.75rem}
    .header h1{font-size:1.1rem;font-weight:600;color:var(--orange);letter-spacing:.01em}
    .header-subtitle{font-size:.75rem;color:var(--text-muted)}
    .header-actions{display:flex;gap:.5rem;align-items:center}
    .btn{background:var(--surface2);border:1px solid var(--border2);color:var(--text-muted);padding:.35rem .85rem;border-radius:6px;cursor:pointer;font-size:.78rem;font-family:var(--font);text-decoration:none;display:inline-flex;align-items:center;gap:.35rem;transition:all .15s}
    .btn:hover{color:var(--text);border-color:var(--orange);background:var(--orange-dim)}
    .btn-primary{background:var(--orange);color:#000;border-color:var(--orange);font-weight:600}
    .btn-primary:hover{background:#e08500;color:#000}
    .btn-sm{padding:.22rem .6rem;font-size:.72rem}
    .btn-call{background:rgba(48,209,88,.1);border-color:rgba(48,209,88,.35);color:var(--green)}
    .btn-call:hover{background:rgba(48,209,88,.2);border-color:var(--green);color:var(--green)}
    .btn-email{background:rgba(10,132,255,.1);border-color:rgba(10,132,255,.3);color:#4da6ff}
    .btn-email:hover{background:rgba(10,132,255,.2);border-color:var(--blue);color:var(--blue)}
    .btn-map{background:rgba(191,90,242,.1);border-color:rgba(191,90,242,.3);color:#d080ff}
    .btn-map:hover{background:rgba(191,90,242,.2);border-color:var(--purple);color:var(--purple)}
    .btn-advance{background:rgba(255,149,0,.1);border-color:rgba(255,149,0,.3);color:var(--orange)}
    .btn-advance:hover{background:rgba(255,149,0,.2);border-color:var(--orange)}
    .btn-advance.confirmed{background:rgba(48,209,88,.15);border-color:var(--green);color:var(--green)}
    .nav-back{font-size:.78rem;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:.35rem}
    .nav-back:hover{color:var(--orange)}
    #due-banner{display:none;background:rgba(255,69,58,.12);border-bottom:1px solid rgba(255,69,58,.3);padding:.65rem 1.5rem;font-size:.82rem;color:var(--red);align-items:center;gap:.5rem}
    #due-banner.visible{display:flex}
    .due-items{display:flex;gap:.75rem;flex-wrap:wrap;margin-left:.5rem}
    .due-chip{background:rgba(255,69,58,.15);border:1px solid rgba(255,69,58,.3);border-radius:4px;padding:.15rem .5rem;font-size:.75rem;color:var(--red)}
    .pipeline-bar{padding:1rem 1.5rem 0}
    .pipeline-stages{display:flex;gap:.5rem;flex-wrap:wrap}
    .stage-pill{display:flex;align-items:center;gap:.35rem;padding:.4rem .75rem;border-radius:20px;font-size:.75rem;font-weight:500;border:1px solid transparent;transition:all .15s}
    .stage-pill .count{font-size:.85rem;font-weight:700}
    .stage-pill.researched{background:rgba(110,110,115,.15);border-color:rgba(110,110,115,.3);color:#9e9ea6}
    .stage-pill.contacted{background:rgba(10,132,255,.15);border-color:rgba(10,132,255,.3);color:#4da6ff}
    .stage-pill.replied{background:rgba(191,90,242,.15);border-color:rgba(191,90,242,.3);color:#d080ff}
    .stage-pill.meeting_scheduled{background:rgba(255,149,0,.15);border-color:rgba(255,149,0,.3);color:var(--orange)}
    .stage-pill.demo_done{background:rgba(255,214,10,.15);border-color:rgba(255,214,10,.3);color:#ffd60a}
    .stage-pill.proposal{background:rgba(50,210,210,.15);border-color:rgba(50,210,210,.3);color:var(--teal)}
    .stage-pill.closed_won{background:rgba(48,209,88,.15);border-color:rgba(48,209,88,.3);color:var(--green)}
    .stage-pill.closed_lost{background:rgba(255,69,58,.15);border-color:rgba(255,69,58,.3);color:var(--red)}
    .tabs-bar{padding:1rem 1.5rem 0;border-bottom:1px solid var(--border);display:flex;gap:0}
    .tab{padding:.6rem 1.25rem;border:none;background:transparent;color:var(--text-muted);font-size:.85rem;font-family:var(--font);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--orange);border-bottom-color:var(--orange)}
    .main{padding:1.25rem 1.5rem}
    /* Morning Briefing */
    .briefing-card{background:linear-gradient(135deg,rgba(255,149,0,.07) 0%,rgba(255,149,0,.03) 100%);border:1px solid rgba(255,149,0,.22);border-radius:10px;padding:1rem 1.25rem;margin-bottom:1.25rem}
    .briefing-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem}
    .briefing-header h3{font-size:.88rem;font-weight:600;color:var(--orange)}
    .briefing-header .date{font-size:.75rem;color:var(--text-muted);margin-left:auto}
    .briefing-stats{display:flex;gap:1.5rem;flex-wrap:wrap;align-items:flex-start}
    .briefing-divider{width:1px;background:var(--border2);align-self:stretch}
    .bstat{display:flex;flex-direction:column;gap:.15rem}
    .bstat .val{font-size:1.5rem;font-weight:700;color:var(--text);line-height:1}
    .bstat .val.warn{color:var(--red)}
    .bstat .val.ok{color:var(--green)}
    .bstat .lbl{font-size:.67rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em}
    .briefing-footer{margin-top:.75rem;padding-top:.65rem;border-top:1px solid var(--border);font-size:.75rem;color:var(--text-muted);display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .overdue-chips{display:flex;flex-wrap:wrap;gap:.35rem}
    .overdue-chip{background:rgba(255,69,58,.12);border:1px solid rgba(255,69,58,.3);border-radius:4px;padding:.1rem .4rem;font-size:.7rem;color:var(--red)}
    /* Cards */
    .prospects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
    .prospect-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .15s,transform .15s}
    .prospect-card:hover{border-color:var(--border2);transform:translateY(-1px)}
    .prospect-card.expanded{border-color:var(--orange);transform:none}
    .card-top{padding:.875rem 1rem .4rem;display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem;cursor:pointer}
    .card-top-left{flex:1;min-width:0}
    .facility-name{font-size:.92rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:.2rem}
    .facility-address{font-size:.73rem;color:var(--text-muted)}
    .card-badges{display:flex;flex-direction:column;align-items:flex-end;gap:.3rem;flex-shrink:0}
    .stage-badge{font-size:.68rem;font-weight:600;padding:.2rem .5rem;border-radius:4px;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
    .stage-badge.researched{background:rgba(110,110,115,.2);color:#9e9ea6}
    .stage-badge.contacted{background:rgba(10,132,255,.2);color:#4da6ff}
    .stage-badge.replied{background:rgba(191,90,242,.2);color:#d080ff}
    .stage-badge.meeting_scheduled{background:rgba(255,149,0,.2);color:var(--orange)}
    .stage-badge.demo_done{background:rgba(255,214,10,.2);color:#ffd60a}
    .stage-badge.proposal{background:rgba(50,210,210,.2);color:var(--teal)}
    .stage-badge.closed_won{background:rgba(48,209,88,.2);color:var(--green)}
    .stage-badge.closed_lost{background:rgba(255,69,58,.2);color:var(--red)}
    .priority-dot{width:8px;height:8px;border-radius:50%}
    .priority-dot.high{background:var(--red)}
    .priority-dot.medium{background:var(--yellow)}
    .priority-dot.low{background:var(--gray)}
    .card-meta{padding:.3rem 1rem .3rem;display:flex;gap:1rem;cursor:pointer}
    .meta-item{display:flex;flex-direction:column;gap:.15rem}
    .meta-label{font-size:.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.06em}
    .meta-value{font-size:.78rem;color:var(--text-muted)}
    .meta-value.overdue{color:var(--red);font-weight:600}
    .meta-value.due-today{color:var(--yellow);font-weight:600}
    .card-actions{padding:.45rem 1rem .6rem;display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}
    .card-notes{padding:0 1rem .75rem;font-size:.75rem;color:var(--text-muted);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    /* Expanded */
    .card-detail{display:none;border-top:1px solid var(--border);background:var(--bg2)}
    .prospect-card.expanded .card-detail{display:block}
    .detail-section{padding:1rem;border-bottom:1px solid var(--border)}
    .detail-section:last-child{border-bottom:none}
    .detail-section h4{font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:.65rem}
    .contact-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.6rem}
    .contact-field label{font-size:.65rem;color:var(--text-dim);display:block;margin-bottom:.2rem}
    .contact-field input{width:100%;background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:.35rem .5rem;border-radius:5px;font-size:.78rem;font-family:var(--font);transition:border-color .15s}
    .contact-field input:focus{outline:none;border-color:var(--orange)}
    .contact-cta{display:flex;gap:.4rem;margin-top:.4rem}
    .stage-update{display:flex;gap:.5rem;align-items:center}
    .stage-select{flex:1;background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:.4rem .6rem;border-radius:5px;font-size:.82rem;font-family:var(--font);cursor:pointer}
    .stage-select:focus{outline:none;border-color:var(--orange)}
    .touchpoint-list{display:flex;flex-direction:column;gap:.5rem;max-height:220px;overflow-y:auto}
    .touchpoint{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:.5rem .75rem}
    .tp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem}
    .tp-type{font-size:.75rem;font-weight:600;color:var(--orange)}
    .tp-date{font-size:.68rem;color:var(--text-dim)}
    .tp-note{font-size:.78rem;color:var(--text-muted);line-height:1.4}
    .tp-followup{font-size:.7rem;color:var(--teal);margin-top:.25rem}
    .no-touchpoints{font-size:.78rem;color:var(--text-dim);font-style:italic}
    .add-note-form{display:flex;flex-direction:column;gap:.5rem}
    .add-note-row{display:flex;gap:.5rem}
    .add-note-form textarea{width:100%;background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:.5rem .65rem;border-radius:5px;font-size:.82rem;font-family:var(--font);resize:vertical;min-height:60px}
    .add-note-form textarea:focus{outline:none;border-color:var(--orange)}
    .type-select{background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:.4rem .6rem;border-radius:5px;font-size:.78rem;font-family:var(--font);cursor:pointer}
    .followup-input{background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:.4rem .6rem;border-radius:5px;font-size:.78rem;font-family:var(--font);flex:1}
    .loading{display:flex;align-items:center;justify-content:center;padding:3rem;color:var(--text-muted);flex-direction:column;gap:1rem}
    .spinner{width:28px;height:28px;border:2px solid var(--border2);border-top-color:var(--orange);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:3rem;color:var(--text-dim);font-size:.85rem}
    #toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:.65rem 1.1rem;font-size:.82rem;color:var(--text);opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;z-index:999;max-width:320px}
    #toast.show{opacity:1;transform:translateY(0)}
    #toast.success{border-color:var(--green);color:var(--green)}
    #toast.error{border-color:var(--red);color:var(--red)}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
    .route-tag{font-size:.65rem;color:var(--text-dim);background:var(--surface2);padding:.15rem .4rem;border-radius:3px}
    .last-updated{font-size:.72rem;color:var(--text-dim)}
    @media(max-width:600px){.prospects-grid{grid-template-columns:1fr}.pipeline-stages{gap:.35rem}.briefing-stats{gap:1rem}}
  </style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <a href="mission-control.html" class="nav-back">‚Üê Mission Control</a>
    <div style="width:1px;height:20px;background:var(--border2)"></div>
    <div>
      <h1>üè• SteriCube Pipeline</h1>
      <div class="header-subtitle">Twin Cities Territory ¬∑ Minneapolis/St. Paul</div>
    </div>
  </div>
  <div class="header-actions">
    <span class="last-updated" id="last-updated">Loading...</span>
    <button class="btn" onclick="loadProspects()">‚Üª Refresh</button>
  </div>
</header>

<div id="due-banner">
  üî¥ <strong>Follow-ups overdue:</strong>
  <div class="due-items" id="due-items"></div>
</div>

<div class="pipeline-bar">
  <div class="pipeline-stages" id="pipeline-stages"></div>
</div>

<div class="tabs-bar">
  <button class="tab active" data-route="all" onclick="switchTab(this)">All</button>
  <button class="tab" data-route="route1_edina" onclick="switchTab(this)">Route 1 ¬∑ Edina</button>
  <button class="tab" data-route="route2_mpls" onclick="switchTab(this)">Route 2 ¬∑ Minneapolis</button>
  <button class="tab" data-route="route3_eagan" onclick="switchTab(this)">Route 3 ¬∑ Eagan</button>
</div>

<div class="main">
  <div id="prospects-container">
    <div class="loading"><div class="spinner"></div><span>Loading prospects‚Ä¶</span></div>
  </div>
</div>

<div id="toast"></div>

<script>
const SUPABASE_URL='https://npnqnsjmcyzkpoqynadr.supabase.co';
const SERVICE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbnFuc2ptY3l6a3BvcXluYWRyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTcyNzEwNywiZXhwIjoyMDg1MzAzMTA3fQ.RNnZZc75S8pLCBK1WBk4orHa19dGbSBUlclPqWbo22E';
const HEADERS={'apikey':SERVICE_KEY,'Authorization':`Bearer ${SERVICE_KEY}`,'Content-Type':'application/json'};

const STAGE_ORDER=['researched','contacted','replied','meeting_scheduled','demo_done','proposal','closed_won','closed_lost'];
const STAGE_LABELS={researched:'Researched',contacted:'Contacted',replied:'Replied',meeting_scheduled:'Meeting',demo_done:'Demo Done',proposal:'Proposal',closed_won:'Won ‚úì',closed_lost:'Lost ‚úó'};
const NEXT_STAGE={
  researched:        {stage:'contacted',         label:'‚Üí Mark Contacted'},
  contacted:         {stage:'replied',            label:'‚Üí Mark Replied'},
  replied:           {stage:'meeting_scheduled',  label:'‚Üí Schedule Meeting'},
  meeting_scheduled: {stage:'demo_done',          label:'‚Üí Demo Done'},
  demo_done:         {stage:'proposal',           label:'‚Üí Send Proposal'},
  proposal:          {stage:'closed_won',         label:'‚Üí Mark Won'},
  closed_won:null, closed_lost:null
};
const TYPE_ICONS={call:'üìû',email:'üìß',visit:'üè•',voicemail:'üì±',note:'üìù'};

let allProspects=[];
let currentRoute='all';

function todayStr(){return new Date().toISOString().slice(0,10)}

async function apiFetch(path,opts={}){
  const isWrite=opts.method&&['POST','PATCH','DELETE'].includes(opts.method);
  const headers={...HEADERS,...(isWrite?{'Prefer':'return=representation'}:{}),...(opts.headers||{})};
  const res=await fetch(`${SUPABASE_URL}/rest/v1/${path}`,{...opts,headers});
  if(!res.ok) throw new Error(`API ${res.status}: ${await res.text()}`);
  const txt=await res.text();
  return txt?JSON.parse(txt):null;
}

async function loadProspects(){
  try{
    allProspects=await apiFetch('stericube_prospects?order=route.asc,priority.desc,facility.asc');
    renderAll();
    document.getElementById('last-updated').textContent='Updated '+new Date().toLocaleTimeString();
  }catch(e){
    document.getElementById('prospects-container').innerHTML=`<div class="empty-state">‚ö†Ô∏è Failed to load: ${e.message}</div>`;
  }
}

function renderAll(){
  renderPipelineSummary();
  renderDueBanner();
  renderProspects();
}

function renderPipelineSummary(){
  const counts={};
  STAGE_ORDER.forEach(s=>counts[s]=0);
  allProspects.forEach(p=>{if(counts[p.stage]!==undefined)counts[p.stage]++;});
  document.getElementById('pipeline-stages').innerHTML=STAGE_ORDER.map(s=>`
    <div class="stage-pill ${s}"><span>${STAGE_LABELS[s]}</span><span class="count">${counts[s]}</span></div>
  `).join('');
}

function renderDueBanner(){
  const today=todayStr();
  const overdue=allProspects.filter(p=>p.next_followup_date&&p.next_followup_date.slice(0,10)<today);
  const banner=document.getElementById('due-banner');
  if(overdue.length===0){banner.classList.remove('visible');return;}
  banner.classList.add('visible');
  document.getElementById('due-items').innerHTML=overdue.map(p=>
    `<span class="due-chip">${escHtml(p.facility.split(' ').slice(0,3).join(' '))} ‚Äî ${p.next_followup_date.slice(0,10)}</span>`
  ).join('');
}

function routeBriefingHtml(prospects){
  if(prospects.length===0) return '';
  const today=todayStr();
  const total=prospects.length;
  const contacted=prospects.filter(p=>p.stage!=='researched').length;
  const uncontacted=total-contacted;
  const overdue=prospects.filter(p=>p.next_followup_date&&p.next_followup_date.slice(0,10)<today);
  const dueToday=prospects.filter(p=>p.next_followup_date&&p.next_followup_date.slice(0,10)===today);
  const overdueHtml=overdue.length>0
    ?`<div class="overdue-chips">${overdue.map(p=>`<span class="overdue-chip">${escHtml(p.facility.split(' ').slice(0,2).join(' '))}</span>`).join('')}</div>`
    :`<span style="color:var(--green)">‚úì None overdue</span>`;

  return `<div class="briefing-card">
    <div class="briefing-header">
      <span style="font-size:1.1rem">‚òÄÔ∏è</span>
      <h3>Morning Briefing</h3>
      <span class="date">${new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})}</span>
    </div>
    <div class="briefing-stats">
      <div class="bstat"><div class="val">${total}</div><div class="lbl">Total Prospects</div></div>
      <div class="briefing-divider"></div>
      <div class="bstat"><div class="val ok">${contacted}</div><div class="lbl">Contacted</div></div>
      <div class="bstat"><div class="val${uncontacted>0?' warn':''}">${uncontacted}</div><div class="lbl">Not Yet Contacted</div></div>
      <div class="briefing-divider"></div>
      <div class="bstat"><div class="val${overdue.length>0?' warn':' ok'}">${overdue.length}</div><div class="lbl">Overdue</div></div>
      <div class="bstat"><div class="val${dueToday.length>0?' warn':''}">${dueToday.length}</div><div class="lbl">Due Today</div></div>
    </div>
    <div class="briefing-footer">
      üöó ~15 min between stops &nbsp;|&nbsp;
      ${overdue.length>0?`‚ö†Ô∏è Overdue: ${overdueHtml}`:''}
    </div>
  </div>`;
}

function renderProspects(){
  const filtered=currentRoute==='all'?allProspects:allProspects.filter(p=>p.route===currentRoute);
  const container=document.getElementById('prospects-container');
  if(filtered.length===0){container.innerHTML='<div class="empty-state">No prospects for this route yet.</div>';return;}
  const briefing=currentRoute==='all'?'':routeBriefingHtml(filtered);
  container.innerHTML=briefing+`<div class="prospects-grid">${filtered.map(renderCard).join('')}</div>`;
}

function renderCard(p){
  const today=todayStr();
  const lcd=p.last_contact_date?p.last_contact_date.slice(0,10):null;
  const nfd=p.next_followup_date?p.next_followup_date.slice(0,10):null;

  let daysSince='‚Äî';
  if(lcd){
    const diff=Math.floor((Date.now()-new Date(lcd+'T12:00:00'))/86400000);
    daysSince=diff===0?'Today':diff===1?'Yesterday':`${diff}d ago`;
  }

  let nfdClass='';
  let nfdDisplay=nfd||'‚Äî';
  if(nfd){
    if(nfd<today)nfdClass='overdue';
    else if(nfd===today)nfdClass='due-today';
  }

  const stage=p.stage||'researched';
  const stageName=stage.replace(/_/g,' ');

  // Contact action buttons
  const callBtn=p.contact_phone
    ?`<a class="btn btn-sm btn-call" href="tel:${escAttr(p.contact_phone)}" onclick="event.stopPropagation()">üìû Call</a>`
    :'';
  const emailBtn=p.contact_email
    ?`<a class="btn btn-sm btn-email" href="mailto:${escAttr(p.contact_email)}" onclick="event.stopPropagation()">üìß Email</a>`
    :'';
  const mapBtn=p.address
    ?`<a class="btn btn-sm btn-map" href="https://maps.google.com/?q=${encodeURIComponent(p.address)}" target="_blank" onclick="event.stopPropagation()">üó∫Ô∏è Directions</a>`
    :'';

  // Stage advance button
  const next=NEXT_STAGE[stage];
  const advBtn=next
    ?`<button class="btn btn-sm btn-advance" id="adv-${p.id}" onclick="advanceStage('${p.id}','${next.stage}',this);event.stopPropagation()">${next.label}</button>`
    :'';

  const contactNameMeta = p.contact_name
    ? `<div class="meta-item"><span class="meta-label">Contact</span><span class="meta-value">${escHtml(p.contact_name)}</span></div>` : '';

  return `
  <div class="prospect-card" id="card-${p.id}">
    <div class="card-top" onclick="toggleCard('${p.id}')">
      <div class="card-top-left">
        <div class="facility-name">${escHtml(p.facility)}</div>
        <div class="facility-address">${escHtml(p.address||'')}</div>
      </div>
      <div class="card-badges">
        <span class="stage-badge ${stage}" id="badge-${p.id}">${stageName}</span>
        <div style="display:flex;align-items:center;gap:.35rem;justify-content:flex-end">
          <span class="priority-dot ${p.priority||'medium'}"></span>
          <span class="route-tag">${routeShort(p.route)}</span>
        </div>
      </div>
    </div>

    <div class="card-meta" onclick="toggleCard('${p.id}')">
      <div class="meta-item">
        <span class="meta-label">Last Contact</span>
        <span class="meta-value">${daysSince}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Next Followup</span>
        <span class="meta-value ${nfdClass}">${nfdDisplay}</span>
      </div>
      ${contactNameMeta}
    </div>

    <div class="card-actions">
      ${callBtn}${emailBtn}${mapBtn}${advBtn}
    </div>

    ${p.notes ? `<div class="card-notes">${escHtml(p.notes)}</div>` : ''}

    <div class="card-detail" id="detail-${p.id}">

      <div class="detail-section">
        <h4>Contact Info</h4>
        <div class="contact-grid">
          <div class="contact-field">
            <label>Name</label>
            <input type="text" placeholder="Contact name" value="${escAttr(p.contact_name||'')}"
              id="inp-contact_name-${p.id}" onchange="saveContact('${p.id}')">
          </div>
          <div class="contact-field">
            <label>Role/Title</label>
            <input type="text" placeholder="e.g. OR Manager" value="${escAttr(p.contact_role||'')}"
              id="inp-contact_role-${p.id}" onchange="saveContact('${p.id}')">
          </div>
          <div class="contact-field">
            <label>Phone</label>
            <input type="tel" placeholder="612-555-0100" value="${escAttr(p.contact_phone||'')}"
              id="inp-contact_phone-${p.id}" onchange="saveContact('${p.id}')">
          </div>
          <div class="contact-field">
            <label>Email</label>
            <input type="email" placeholder="contact@hospital.org" value="${escAttr(p.contact_email||'')}"
              id="inp-contact_email-${p.id}" onchange="saveContact('${p.id}')">
          </div>
        </div>
        <div class="contact-cta">
          ${p.contact_phone ? `<a class="btn btn-sm btn-call" href="tel:${escAttr(p.contact_phone)}" onclick="event.stopPropagation()">üìû Call</a>` : ''}
          ${p.contact_email ? `<a class="btn btn-sm btn-email" href="mailto:${escAttr(p.contact_email)}" onclick="event.stopPropagation()">üìß Email</a>` : ''}
          ${p.address ? `<a class="btn btn-sm btn-map" href="https://maps.google.com/?q=${encodeURIComponent(p.address)}" target="_blank" onclick="event.stopPropagation()">üó∫Ô∏è Directions</a>` : ''}
        </div>
      </div>

      <div class="detail-section">
        <h4>Pipeline Stage</h4>
        <div class="stage-update">
          <select class="stage-select" id="stage-${p.id}">
            ${STAGE_ORDER.map(s => `<option value="${s}" ${p.stage===s?'selected':''}>${STAGE_LABELS[s]}</option>`).join('')}
          </select>
          <button class="btn btn-primary" onclick="updateStage('${p.id}'); event.stopPropagation()">Update</button>
        </div>
        <div style="margin-top:.65rem">
          <label style="font-size:.65rem;color:var(--text-dim);display:block;margin-bottom:.2rem">NOTES</label>
          <textarea id="inp-notes-${p.id}"
            style="width:100%;background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:.45rem .6rem;border-radius:5px;font-size:.8rem;font-family:var(--font);resize:vertical;min-height:50px"
            placeholder="General notes about this account..."
            onchange="saveNotes('${p.id}')" onclick="event.stopPropagation()">${escHtml(p.notes||'')}</textarea>
        </div>
      </div>

      <div class="detail-section">
        <h4>Touchpoint History</h4>
        <div class="touchpoint-list" id="tp-list-${p.id}">
          <div style="font-size:.75rem;color:var(--text-dim)">Loading history‚Ä¶</div>
        </div>
      </div>

      <div class="detail-section">
        <h4>Log Touchpoint</h4>
        <div class="add-note-form">
          <textarea id="tp-note-${p.id}" placeholder="What happened? What was said?..." onclick="event.stopPropagation()"></textarea>
          <div class="add-note-row">
            <select class="type-select" id="tp-type-${p.id}" onclick="event.stopPropagation()">
              <option value="note">üìù Note</option>
              <option value="call">üìû Call</option>
              <option value="email">üìß Email</option>
              <option value="visit">üè• Visit</option>
              <option value="voicemail">üì± Voicemail</option>
            </select>
            <input type="date" class="followup-input" id="tp-followup-${p.id}" onclick="event.stopPropagation()">
            <button class="btn btn-primary" onclick="addTouchpoint('${p.id}'); event.stopPropagation()">Log</button>
          </div>
        </div>
      </div>

    </div>
  </div>`;
}

function routeShort(r){
  switch(r){
    case 'route1_edina': return 'R1¬∑Edina';
    case 'route2_mpls':  return 'R2¬∑MPLS';
    case 'route3_eagan': return 'R3¬∑Eagan';
    default: return r||'';
  }
}

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escAttr(s){
  return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function switchTab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  currentRoute=el.dataset.route;
  renderProspects();
}

async function toggleCard(id){
  const card=document.getElementById('card-'+id);
  const isExpanded=card.classList.contains('expanded');
  document.querySelectorAll('.prospect-card.expanded').forEach(c=>{
    if(c.id!=='card-'+id) c.classList.remove('expanded');
  });
  if(isExpanded){
    card.classList.remove('expanded');
  } else {
    card.classList.add('expanded');
    await loadTouchpoints(id);
  }
}

async function loadTouchpoints(prospectId){
  const container=document.getElementById('tp-list-'+prospectId);
  try{
    const tps=await apiFetch('stericube_touchpoints?prospect_id=eq.'+prospectId+'&order=created_at.desc&limit=5');
    if(!tps||tps.length===0){
      container.innerHTML='<div class="no-touchpoints">No touchpoints logged yet.</div>';
      return;
    }
    container.innerHTML=tps.map(tp=>`
      <div class="touchpoint">
        <div class="tp-header">
          <span class="tp-type">${TYPE_ICONS[tp.type]||'üìù'} ${tp.type}</span>
          <span class="tp-date">${tp.created_at.slice(0,10)}</span>
        </div>
        <div class="tp-note">${escHtml(tp.note||'')}</div>
        ${tp.next_followup_date?`<div class="tp-followup">‚Üí Follow up: ${tp.next_followup_date.slice(0,10)}</div>`:''}
      </div>
    `).join('');
  }catch(e){
    container.innerHTML=`<div class="no-touchpoints">Error: ${e.message}</div>`;
  }
}

async function advanceStage(id, newStage, btn){
  btn.disabled=true;
  btn.textContent='Saving‚Ä¶';
  try{
    await apiFetch('stericube_prospects?id=eq.'+id,{
      method:'PATCH',
      body:JSON.stringify({stage:newStage, updated_at:new Date().toISOString()})
    });
    const p=allProspects.find(x=>x.id===id);
    if(p) p.stage=newStage;
    // Update badge
    const badge=document.getElementById('badge-'+id);
    if(badge){badge.className='stage-badge '+newStage;badge.textContent=newStage.replace(/_/g,' ');}
    // Update advance button
    const next=NEXT_STAGE[newStage];
    if(next){
      btn.className='btn btn-sm btn-advance';
      btn.textContent=next.label;
      btn.onclick=function(e){advanceStage(id,next.stage,btn);e.stopPropagation();};
      btn.disabled=false;
    } else {
      btn.className='btn btn-sm btn-advance confirmed';
      btn.textContent='‚úì Done';
      btn.disabled=true;
    }
    // Update stage select in expanded panel if open
    const sel=document.getElementById('stage-'+id);
    if(sel) sel.value=newStage;
    renderPipelineSummary();
    showToast('Stage ‚Üí '+newStage.replace(/_/g,' ')+' ‚úì','success');
  }catch(e){
    btn.disabled=false;
    btn.textContent=NEXT_STAGE[allProspects.find(x=>x.id===id)?.stage||'researched']?.label||'Advance';
    showToast('Failed: '+e.message,'error');
  }
}

async function updateStage(id){
  const select=document.getElementById('stage-'+id);
  const newStage=select.value;
  try{
    await apiFetch('stericube_prospects?id=eq.'+id,{
      method:'PATCH',
      body:JSON.stringify({stage:newStage, updated_at:new Date().toISOString()})
    });
    const p=allProspects.find(x=>x.id===id);
    if(p) p.stage=newStage;
    const badge=document.getElementById('badge-'+id);
    if(badge){badge.className='stage-badge '+newStage;badge.textContent=newStage.replace(/_/g,' ');}
    // Sync advance button
    const next=NEXT_STAGE[newStage];
    const advBtn=document.getElementById('adv-'+id);
    if(advBtn){
      if(next){
        advBtn.className='btn btn-sm btn-advance';
        advBtn.textContent=next.label;
        advBtn.onclick=function(e){advanceStage(id,next.stage,advBtn);e.stopPropagation();};
        advBtn.disabled=false;
      } else {
        advBtn.className='btn btn-sm btn-advance confirmed';
        advBtn.textContent='‚úì Done';
        advBtn.disabled=true;
      }
    }
    renderPipelineSummary();
    showToast('Stage updated ‚úì','success');
  }catch(e){
    showToast('Failed: '+e.message,'error');
  }
}

async function saveContact(id){
  const fields=['contact_name','contact_role','contact_phone','contact_email'];
  const data={};
  fields.forEach(f=>{
    const el=document.getElementById('inp-'+f+'-'+id);
    if(el) data[f]=el.value||null;
  });
  data.updated_at=new Date().toISOString();
  try{
    await apiFetch('stericube_prospects?id=eq.'+id,{
      method:'PATCH',body:JSON.stringify(data)
    });
    const p=allProspects.find(x=>x.id===id);
    if(p) Object.assign(p,data);
    showToast('Contact saved ‚úì','success');
  }catch(e){
    showToast('Save failed: '+e.message,'error');
  }
}

async function saveNotes(id){
  const notes=document.getElementById('inp-notes-'+id).value||null;
  try{
    await apiFetch('stericube_prospects?id=eq.'+id,{
      method:'PATCH',body:JSON.stringify({notes, updated_at:new Date().toISOString()})
    });
    const p=allProspects.find(x=>x.id===id);
    if(p) p.notes=notes;
    showToast('Notes saved ‚úì','success');
  }catch(e){
    showToast('Save failed: '+e.message,'error');
  }
}

async function addTouchpoint(prospectId){
  const noteEl=document.getElementById('tp-note-'+prospectId);
  const typeEl=document.getElementById('tp-type-'+prospectId);
  const followupEl=document.getElementById('tp-followup-'+prospectId);
  const note=noteEl.value.trim();
  if(!note){showToast('Add a note first','error');return;}

  const payload={
    prospect_id:prospectId,
    type:typeEl.value,
    note,
    next_followup_date:followupEl.value||null
  };
  const today=todayStr();
  const patch={last_contact_date:today, updated_at:new Date().toISOString()};
  if(followupEl.value) patch.next_followup_date=followupEl.value;

  try{
    await apiFetch('stericube_touchpoints',{method:'POST',body:JSON.stringify(payload)});
    await apiFetch('stericube_prospects?id=eq.'+prospectId,{method:'PATCH',body:JSON.stringify(patch)});
    const p=allProspects.find(x=>x.id===prospectId);
    if(p){
      p.last_contact_date=today;
      if(followupEl.value) p.next_followup_date=followupEl.value;
    }
    noteEl.value='';
    followupEl.value='';
    typeEl.value='note';
    await loadTouchpoints(prospectId);
    renderPipelineSummary();
    renderDueBanner();
    showToast('Touchpoint logged ‚úì','success');
  }catch(e){
    showToast('Failed: '+e.message,'error');
  }
}

let toastTimer;
function showToast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='show '+(type||'');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.className='',2800);
}

// Init
loadProspects();
</script>
</body>
</html>