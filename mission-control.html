<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mission Control v2</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f0f0f; --surface: #161616; --surface2: #1e1e1e;
      --border: #2a2a2a; --border2: #333;
      --text: #e8e8e8; --text-muted: #888; --text-dim: #555;
      --orange: #ff9500; --orange-dim: rgba(255,149,0,0.12); --orange-glow: rgba(255,149,0,0.3);
      --green: #30d158; --yellow: #ffd60a; --red: #ff453a;
      --blue: #0a84ff; --purple: #bf5af2; --teal: #32d2c2;
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      --mono: 'SF Mono', 'Fira Code', monospace;
    }
    body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; line-height: 1.5; }

    /* HEADER */
    .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.875rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header-logo { font-size: 1.2rem; font-weight: 700; color: var(--orange); letter-spacing: -0.02em; }
    .header-sub { color: var(--text-dim); font-size: 0.7rem; font-family: var(--mono); margin-left: 0.5rem; }
    .header-right { display: flex; align-items: center; gap: 0.75rem; }
    .refresh-btn { background: var(--surface2); border: 1px solid var(--border2); color: var(--text-muted); padding: 0.35rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-family: var(--font); transition: all 0.15s; }
    .refresh-btn:hover { color: var(--text); border-color: var(--orange); }
    .last-refresh { font-size: 0.68rem; color: var(--text-dim); font-family: var(--mono); }
    .live-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ACTION BAR */
    .action-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.6rem 1.5rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .action-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-right: 0.25rem; }
    .action-btn { background: var(--surface2); border: 1px solid var(--border2); color: var(--text-muted); padding: 0.33rem 0.875rem; border-radius: 6px; cursor: pointer; font-size: 0.78rem; font-family: var(--font); text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; transition: all 0.15s; }
    .action-btn:hover { color: var(--text); border-color: var(--orange); background: var(--orange-dim); }

    /* SCOUT MODAL */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: var(--surface); border: 1px solid var(--border2); border-radius: 12px; padding: 1.5rem; max-width: 480px; width: 90%; }
    .modal-title { font-weight: 700; font-size: 1rem; margin-bottom: 0.75rem; color: var(--orange); }
    .modal-body { color: var(--text-muted); font-size: 0.875rem; line-height: 1.6; margin-bottom: 1rem; }
    .modal-code { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.875rem; font-family: var(--mono); font-size: 0.78rem; color: var(--green); overflow-x: auto; margin-bottom: 0.75rem; }
    .modal-note { color: var(--text-dim); font-size: 0.73rem; line-height: 1.5; margin-bottom: 1rem; }
    .modal-close { background: var(--surface2); border: 1px solid var(--border2); color: var(--text); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.82rem; font-family: var(--font); }

    /* PAGE */
    .page { max-width: 1400px; margin: 0 auto; padding: 1.25rem 1.5rem 3rem; display: flex; flex-direction: column; gap: 1.25rem; }

    /* SECTION TITLE */
    .section-title { font-size: 0.68rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    /* AGENT BAR */
    .agent-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .agent-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.875rem; }
    .agent-orb { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
    .orb-green  { background: var(--green);  box-shadow: 0 0 8px var(--green); }
    .orb-yellow { background: var(--yellow); box-shadow: 0 0 8px var(--yellow); }
    .orb-red    { background: var(--red);    box-shadow: 0 0 8px var(--red); }
    .agent-emoji-big { font-size: 2rem; flex-shrink: 0; line-height: 1; }
    .agent-info { flex: 1; min-width: 0; }
    .agent-name-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.2rem; }
    .agent-name { font-weight: 700; font-size: 0.95rem; }
    .agent-badge { font-size: 0.62rem; font-weight: 600; padding: 0.12rem 0.4rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.06em; }
    .badge-active  { background: rgba(48,209,88,.15); color: var(--green); }
    .badge-idle    { background: rgba(255,214,10,.15); color: var(--yellow); }
    .badge-offline { background: rgba(255,69,58,.15);  color: var(--red); }
    .agent-action  { font-size: 0.77rem; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .agent-time { font-size: 0.68rem; color: var(--text-dim); font-family: var(--mono); flex-shrink: 0; text-align: right; }

    /* ACTION INBOX */
    .inbox-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
    .inbox-title { font-size: 0.68rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; }
    .inbox-count { background: var(--orange); color: #000; font-size: 0.62rem; font-weight: 700; padding: 0.1rem 0.4rem; border-radius: 10px; min-width: 18px; text-align: center; }
    .inbox-count.zero { background: var(--surface2); color: var(--text-dim); }
    .inbox-spacer { flex: 1; height: 1px; background: var(--border); }
    .inbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 0.75rem; }
    .inbox-item { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--orange); border-radius: 8px; padding: 0.875rem 1rem; transition: background 0.15s, border-color 0.15s; }
    .inbox-item:hover { background: var(--surface2); border-color: var(--orange); }
    .inbox-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.375rem; }
    .inbox-title-text { font-weight: 600; font-size: 0.875rem; line-height: 1.3; }
    .p-badge { font-size: 0.58rem; font-weight: 700; padding: 0.12rem 0.38rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.05em; flex-shrink: 0; }
    .p-high   { background: rgba(255,69,58,.2);  color: var(--red); }
    .p-medium { background: rgba(255,149,0,.18); color: var(--orange); }
    .p-low    { background: rgba(10,132,255,.15); color: var(--blue); }
    .inbox-meta { font-size: 0.7rem; color: var(--text-dim); display: flex; gap: 0.5rem; align-items: center; }
    .s-pill { font-size: 0.58rem; font-weight: 600; padding: 0.1rem 0.32rem; border-radius: 3px; background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); text-transform: uppercase; }
    .inbox-clear { background: var(--surface); border: 1px dashed var(--border); border-radius: 8px; padding: 1.25rem; text-align: center; color: var(--green); font-size: 0.85rem; font-weight: 500; }

    /* MIDDLE ROW */
    .middle-row { display: grid; grid-template-columns: 320px 1fr; gap: 1.25rem; align-items: start; }

    /* KANBAN SUMMARY */
    .kanban-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .card-header { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-weight: 700; font-size: 0.875rem; }
    .card-link { font-size: 0.72rem; color: var(--orange); text-decoration: none; opacity: .8; }
    .card-link:hover { opacity: 1; }
    .k-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); }
    .k-stat { background: var(--surface); padding: 0.875rem; text-align: center; }
    .k-stat:hover { background: var(--surface2); }
    .k-num { font-size: 1.7rem; font-weight: 800; line-height: 1; margin-bottom: 0.2rem; }
    .k-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.07em; }
    .num-b { color: var(--text-muted); }
    .num-t { color: var(--blue); }
    .num-p { color: var(--orange); }
    .num-d { color: var(--green); }
    .card-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border); }
    .k-btn { display: block; text-align: center; background: var(--orange-dim); border: 1px solid var(--orange); color: var(--orange); text-decoration: none; padding: 0.5rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; transition: all 0.15s; }
    .k-btn:hover { background: var(--orange); color: #000; }

    /* ACTIVITY FEED */
    .feed-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .feed-list { max-height: 420px; overflow-y: auto; }
    .feed-item { display: grid; grid-template-columns: auto 1fr auto; gap: 0.75rem; padding: 0.7rem 1rem; border-bottom: 1px solid var(--border); transition: background 0.1s; }
    .feed-item:last-child { border-bottom: none; }
    .feed-item:hover { background: var(--surface2); }
    .feed-ch { font-size: 0.6rem; font-weight: 600; padding: 0.12rem 0.38rem; border-radius: 4px; background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); text-transform: uppercase; letter-spacing: .04em; white-space: nowrap; align-self: start; }
    .feed-body { min-width: 0; }
    .feed-sess { font-size: 0.62rem; color: var(--text-dim); font-family: var(--mono); margin-bottom: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .feed-content { font-size: 0.78rem; color: var(--text-muted); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .feed-time { font-size: 0.62rem; color: var(--text-dim); font-family: var(--mono); white-space: nowrap; align-self: start; }

    /* ACTIVITY LOG */
    .log-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .log-count { font-size: 0.68rem; color: var(--text-dim); font-family: var(--mono); }
    .log-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    .log-table th { padding: 0.5rem 1rem; text-align: left; font-size: 0.62rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); background: var(--surface); border-bottom: 1px solid var(--border); }
    .log-table td { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    .log-table tr:last-child td { border-bottom: none; }
    .log-table tr:hover td { background: var(--surface2); }
    .log-action { font-weight: 600; color: var(--text); margin-bottom: 0.1rem; }
    .log-desc { color: var(--text-muted); font-size: 0.73rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .log-source { color: var(--text-dim); font-size: 0.7rem; font-family: var(--mono); }
    .log-time { color: var(--text-dim); font-size: 0.65rem; font-family: var(--mono); white-space: nowrap; }
    .cat { font-size: 0.58rem; font-weight: 700; padding: 0.12rem 0.42rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; display: inline-block; }
    .cat-infrastructure { background: rgba(10,132,255,.15);  color: var(--blue); }
    .cat-content        { background: rgba(48,209,88,.15);   color: var(--green); }
    .cat-cost           { background: rgba(255,149,0,.15);   color: var(--orange); }
    .cat-incident       { background: rgba(255,69,58,.15);   color: var(--red); }
    .cat-engagement     { background: rgba(191,90,242,.15);  color: var(--purple); }
    .cat-research       { background: rgba(50,210,194,.15);  color: var(--teal); }
    .cat-task           { background: rgba(255,214,10,.15);  color: var(--yellow); }
    .cat-other          { background: var(--surface2);        color: var(--text-muted); }

    /* SCOUT FEED */
    .scout-feed { display: flex; flex-direction: column; gap: 0.6rem; }
    .scout-card { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--teal); border-radius: 8px; padding: 0.875rem 1rem; }
    .scout-card:hover { background: var(--surface2); }
    .scout-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.35rem; }
    .scout-title { font-weight: 600; font-size: 0.875rem; color: var(--text); line-height: 1.3; flex: 1; }
    .scout-time { font-size: 0.65rem; color: var(--text-dim); font-family: var(--mono); white-space: nowrap; flex-shrink: 0; }
    .scout-preview { font-size: 0.77rem; color: var(--text-muted); line-height: 1.4; margin-bottom: 0.4rem; }
    .scout-full { display: none; font-size: 0.77rem; color: var(--text-muted); line-height: 1.5; white-space: pre-wrap; word-break: break-word; margin-bottom: 0.4rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; }
    .scout-full.open { display: block; }
    .scout-expand { background: none; border: none; color: var(--teal); font-size: 0.72rem; cursor: pointer; padding: 0; font-family: var(--font); }
    .scout-expand:hover { opacity: .7; }
    .scout-empty { padding: 1.5rem; text-align: center; color: var(--text-dim); font-size: 0.82rem; }

    /* ACTIVITY LOG SEARCH */
    .log-search-bar { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .log-search-input { flex: 1; min-width: 140px; background: var(--bg); border: 1px solid var(--border2); color: var(--text); padding: 0.35rem 0.65rem; border-radius: 6px; font-size: 0.78rem; font-family: var(--font); outline: none; }
    .log-search-input:focus { border-color: var(--orange); }
    .log-cat-select { background: var(--bg); border: 1px solid var(--border2); color: var(--text-muted); padding: 0.35rem 0.55rem; border-radius: 6px; font-size: 0.78rem; font-family: var(--font); outline: none; cursor: pointer; }
    .log-cat-select:focus { border-color: var(--orange); }
    .log-result-count { font-size: 0.68rem; color: var(--text-dim); font-family: var(--mono); white-space: nowrap; }

    /* TASK QUICK-ADD */
    .quick-add-bar { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; padding: 0.6rem 0; margin-bottom: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem 0.875rem; }
    .quick-add-bar input, .quick-add-bar select { background: var(--bg); border: 1px solid var(--border2); color: var(--text); padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.78rem; font-family: var(--font); outline: none; }
    .quick-add-bar input:focus, .quick-add-bar select:focus { border-color: var(--orange); }
    .quick-add-bar input[name="qa-title"] { flex: 1; min-width: 140px; }
    .quick-add-btn { background: var(--orange-dim); border: 1px solid var(--orange); color: var(--orange); padding: 0.35rem 0.875rem; border-radius: 6px; cursor: pointer; font-size: 0.78rem; font-family: var(--font); font-weight: 600; white-space: nowrap; transition: all 0.15s; }
    .quick-add-btn:hover { background: var(--orange); color: #000; }
    .quick-add-confirm { font-size: 0.75rem; color: var(--green); font-weight: 600; display: none; }
    .quick-add-confirm.show { display: inline; }

    /* UTIL */
    .loading { padding: 1.5rem; text-align: center; color: var(--text-dim); font-size: 0.78rem; }
    .loading::after { content: ''; display: inline-block; width: 10px; height: 10px; border: 2px solid var(--border); border-top-color: var(--orange); border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 0.5rem; vertical-align: middle; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

    @media (max-width: 900px) {
      .agent-bar, .middle-row { grid-template-columns: 1fr; }
      .page { padding: 1rem; }
    }
    @media (max-width: 640px) {
      .header-sub { display: none; }
      .log-table th:nth-child(4), .log-table td:nth-child(4) { display: none; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div style="display:flex;align-items:center;">
    <span class="header-logo">üéØ Mission Control</span>
    <span class="header-sub">v2</span>
  </div>
  <div class="header-right">
    <span class="last-refresh" id="last-refresh">loading‚Ä¶</span>
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
    <span class="live-dot" title="Auto-refreshes every 60s"></span>
  </div>
</header>

<!-- QUICK ACTIONS -->
<div class="action-bar">
  <span class="action-label">Actions</span>
  <button class="action-btn" onclick="document.getElementById('scout-modal').classList.add('open')">‚ñ∂ Run Scout</button>
  <a class="action-btn" href="https://twitter.com/MaverickMoltBot" target="_blank" rel="noopener">üê¶ Check Twitter</a>
  <a class="action-btn" href="#inbox-section">‚ö° Action Inbox</a>
  <a class="action-btn" href="#kanban-section">üìã View Tasks</a>
  <a class="action-btn" href="index.html">üìå Full Kanban</a>
  <a class="action-btn" href="cost-dashboard.html">üí∞ Cost</a>
  <a class="action-btn" href="stericube.html">üè• SteriCube Pipeline</a>
</div>

<!-- SCOUT MODAL -->
<div class="modal-overlay" id="scout-modal">
  <div class="modal-box">
    <div class="modal-title">‚ñ∂ Run Scout</div>
    <div class="modal-body">To trigger Scout manually, run this in your terminal:</div>
    <pre class="modal-code">openclaw run --agent scout --task "Run scout analysis"</pre>
    <div class="modal-note">Or wait for Scout's next scheduled run. Check HEARTBEAT.md for the cron schedule.</div>
    <button class="modal-close" onclick="document.getElementById('scout-modal').classList.remove('open')">Close</button>
  </div>
</div>

<main class="page">

  <!-- AGENT STATUS BAR -->
  <section>
    <div class="section-title">Agent Status</div>
    <div class="agent-bar" id="agent-bar">
      <div class="loading">Loading agents</div>
    </div>
  </section>

  <!-- ACTION INBOX -->
  <section id="inbox-section">
    <div class="inbox-header">
      <span class="inbox-title">‚ö° Action Inbox</span>
      <span class="inbox-count zero" id="inbox-count">0</span>
      <span class="inbox-spacer"></span>
    </div>
    <!-- TASK QUICK-ADD -->
    <div class="quick-add-bar">
      <input name="qa-title" id="qa-title" type="text" placeholder="New task title‚Ä¶" maxlength="200" />
      <select id="qa-priority">
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
        <option value="low">Low</option>
      </select>
      <select id="qa-assignee">
        <option value="maverick" selected>Maverick</option>
        <option value="matt">Matt</option>
      </select>
      <button class="quick-add-btn" onclick="quickAddTask()">+ Add Task</button>
      <span class="quick-add-confirm" id="qa-confirm">‚úÖ Task added</span>
    </div>
    <div id="inbox-grid" class="inbox-grid">
      <div class="loading">Loading tasks</div>
    </div>
  </section>

  <!-- SCOUT RESEARCH FEED -->
  <section id="scout-section">
    <div class="section-title">üîç Scout Research Feed</div>
    <div id="scout-feed" class="scout-feed">
      <div class="loading">Loading scout reports</div>
    </div>
  </section>

  <!-- KANBAN SUMMARY + ACTIVITY FEED -->
  <div class="middle-row" id="kanban-section">

    <!-- Kanban Summary -->
    <div class="kanban-card">
      <div class="card-header">
        <span class="card-title">üìã Kanban Summary</span>
        <a href="index.html" class="card-link">Open board ‚Üí</a>
      </div>
      <div class="k-grid" id="k-grid">
        <div class="loading" style="grid-column:1/-1">Loading</div>
      </div>
      <div class="card-footer">
        <a href="index.html" class="k-btn">View Full Board</a>
      </div>
    </div>

    <!-- Activity Feed (messages) -->
    <div class="feed-card">
      <div class="card-header">
        <span class="card-title">üí¨ Activity Feed</span>
        <span style="font-size:.7rem;color:var(--text-dim)">system messages ¬∑ latest 20</span>
      </div>
      <div class="feed-list" id="feed-list">
        <div class="loading">Loading messages</div>
      </div>
    </div>

  </div>

  <!-- FULL ACTIVITY LOG -->
  <section class="log-card">
    <div class="card-header">
      <span class="card-title">üìä Activity Log</span>
      <span class="log-count" id="log-count">loading‚Ä¶</span>
    </div>
    <div class="log-search-bar">
      <input type="text" class="log-search-input" id="log-search" placeholder="Search actions‚Ä¶" oninput="scheduleLogFilter()" />
      <select class="log-cat-select" id="log-cat-filter" onchange="filterLog()">
        <option value="">All</option>
        <option value="infrastructure">Infrastructure</option>
        <option value="content">Content</option>
        <option value="cost">Cost</option>
        <option value="incident">Incident</option>
        <option value="engagement">Engagement</option>
        <option value="research">Research</option>
        <option value="task">Task</option>
      </select>
      <span class="log-result-count" id="log-result-count"></span>
    </div>
    <div style="overflow-x:auto;">
      <table class="log-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Action / Description</th>
            <th>Source</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="log-body">
          <tr><td colspan="4"><div class="loading">Loading activity</div></td></tr>
        </tbody>
      </table>
    </div>
  </section>

</main>

<script>
  const SUPABASE_URL = 'https://npnqnsjmcyzkpoqynadr.supabase.co';
  const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbnFuc2ptY3l6a3BvcXluYWRyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTcyNzEwNywiZXhwIjoyMDg1MzAzMTA3fQ.RNnZZc75S8pLCBK1WBk4orHa19dGbSBUlclPqWbo22E';

  const AGENTS = [
    { id: '32b01c76-bd5d-4885-a35e-c9a13e05dc0f', name: 'Maverick', emoji: 'ü¶Ö', sessionKey: 'agent:main:main' },
    { id: '8f6ffdb1-6afe-4f8d-965c-4cdcdc6db85d', name: 'Scout',    emoji: 'üîç', sessionKey: 'agent:scout' }
  ];

  async function api(endpoint) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
      headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` }
    });
    if (!res.ok) throw new Error(`API ${res.status}: ${endpoint}`);
    return res.json();
  }

  function timeAgo(dateStr) {
    if (!dateStr) return 'never';
    const secs = Math.floor((Date.now() - new Date(dateStr)) / 1000);
    if (secs < 60) return 'just now';
    if (secs < 3600) return `${Math.floor(secs/60)}m ago`;
    if (secs < 86400) return `${Math.floor(secs/3600)}h ago`;
    return `${Math.floor(secs/86400)}d ago`;
  }

  function shortDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
  }

  function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function statusOrb(minutesAgo) {
    if (minutesAgo < 30)    return 'orb-green';
    if (minutesAgo < 240)   return 'orb-yellow';
    return 'orb-red';
  }

  function statusBadge(minutesAgo) {
    if (minutesAgo < 30)  return { cls: 'badge-active',  txt: 'Active' };
    if (minutesAgo < 240) return { cls: 'badge-idle',    txt: 'Idle' };
    return                       { cls: 'badge-offline', txt: 'Offline' };
  }

  function catClass(cat) {
    const known = ['infrastructure','content','cost','incident','engagement','research','task'];
    return known.includes(cat) ? `cat-${cat}` : 'cat-other';
  }

  function priorityClass(p) {
    if (p === 'high') return 'p-high';
    if (p === 'low')  return 'p-low';
    return 'p-medium';
  }

  /* ‚îÄ‚îÄ‚îÄ AGENT STATUS BAR ‚îÄ‚îÄ‚îÄ */
  async function loadAgents() {
    const bar = document.getElementById('agent-bar');
    try {
      // Fetch last message per agent by session_key pattern
      const results = await Promise.all(AGENTS.map(async (agent) => {
        // Try session_key match for maverick (main session) and scout
        const data = await api(
          `messages?session_key=like.*${encodeURIComponent(agent.sessionKey.split(':').pop())}*&order=created_at.desc&limit=1&select=content,created_at,channel`
        );
        return { agent, msg: data[0] || null };
      }));

      bar.innerHTML = results.map(({ agent, msg }) => {
        const minutesAgo = msg
          ? Math.floor((Date.now() - new Date(msg.created_at)) / 60000)
          : 99999;
        const orb = statusOrb(minutesAgo);
        const badge = statusBadge(minutesAgo);
        const preview = msg ? msg.content.replace(/\n/g,' ').substring(0, 80) : 'No recent activity';
        const timeStr = msg ? timeAgo(msg.created_at) : 'never';

        return `
          <div class="agent-card">
            <div class="agent-orb ${orb}"></div>
            <div class="agent-emoji-big">${agent.emoji}</div>
            <div class="agent-info">
              <div class="agent-name-row">
                <span class="agent-name">${agent.name}</span>
                <span class="agent-badge ${badge.cls}">${badge.txt}</span>
              </div>
              <div class="agent-action">${esc(preview)}</div>
            </div>
            <div class="agent-time">${esc(timeStr)}</div>
          </div>`;
      }).join('');
    } catch (e) {
      bar.innerHTML = `<div style="color:var(--red);font-size:.8rem;padding:.5rem">Error loading agents: ${esc(e.message)}</div>`;
    }
  }


  /* ‚îÄ‚îÄ‚îÄ ACTION INBOX ‚îÄ‚îÄ‚îÄ */
  async function loadInbox() {
    const grid = document.getElementById('inbox-grid');
    const countEl = document.getElementById('inbox-count');
    try {
      const tasks = await api('kanban_tasks?assignee=eq.maverick&status=in.(backlog,todo)&order=created_at.desc&limit=20');
      countEl.textContent = tasks.length;
      countEl.className = tasks.length > 0 ? 'inbox-count' : 'inbox-count zero';

      if (!tasks.length) {
        grid.innerHTML = '<div class="inbox-clear">‚úì All clear ‚Äî no pending tasks for Maverick</div>';
        return;
      }
      grid.innerHTML = tasks.map(t => `
        <div class="inbox-item">
          <div class="inbox-top">
            <span class="inbox-title-text">${esc(t.title)}</span>
            <span class="p-badge ${priorityClass(t.priority)}">${esc(t.priority || 'med')}</span>
          </div>
          <div class="inbox-meta">
            <span class="s-pill">${esc(t.status)}</span>
            <span>${shortDate(t.created_at)}</span>
          </div>
        </div>`).join('');
    } catch (e) {
      grid.innerHTML = `<div style="color:var(--red);font-size:.8rem">Error: ${esc(e.message)}</div>`;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ KANBAN SUMMARY ‚îÄ‚îÄ‚îÄ */
  async function loadKanbanSummary() {
    const kgrid = document.getElementById('k-grid');
    try {
      const tasks = await api('kanban_tasks?select=status');
      const counts = { backlog:0, todo:0, 'in-progress':0, done:0 };
      tasks.forEach(t => {
        const s = t.status;
        if (s in counts) counts[s]++;
        else if (s === 'completed') counts.done++;
      });
      const total = tasks.length;
      kgrid.innerHTML = `
        <div class="k-stat">
          <div class="k-num num-b">${counts.backlog}</div>
          <div class="k-label">Backlog</div>
        </div>
        <div class="k-stat">
          <div class="k-num num-t">${counts.todo}</div>
          <div class="k-label">To Do</div>
        </div>
        <div class="k-stat">
          <div class="k-num num-p">${counts['in-progress']}</div>
          <div class="k-label">In Progress</div>
        </div>
        <div class="k-stat">
          <div class="k-num num-d">${counts.done}</div>
          <div class="k-label">Done</div>
        </div>`;
    } catch (e) {
      kgrid.innerHTML = `<div style="color:var(--red);font-size:.8rem;padding:.5rem">Error: ${esc(e.message)}</div>`;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ ACTIVITY FEED (messages) ‚îÄ‚îÄ‚îÄ */
  async function loadFeed() {
    const list = document.getElementById('feed-list');
    try {
      const msgs = await api('messages?role=eq.system&order=created_at.desc&limit=20&select=session_key,channel,content,created_at');
      if (!msgs.length) { list.innerHTML = '<div style="padding:1.5rem;text-align:center;color:var(--text-dim);font-size:.8rem">No system messages yet</div>'; return; }
      list.innerHTML = msgs.map(m => {
        const preview = m.content.replace(/\n+/g,' ').substring(0, 120);
        const sess = m.session_key ? m.session_key.replace('agent:main:','').replace('agent:','') : '?';
        return `
          <div class="feed-item">
            <span class="feed-ch">${esc(m.channel || 'sys')}</span>
            <div class="feed-body">
              <div class="feed-sess">${esc(sess)}</div>
              <div class="feed-content">${esc(preview)}</div>
            </div>
            <span class="feed-time">${timeAgo(m.created_at)}</span>
          </div>`;
      }).join('');
    } catch (e) {
      list.innerHTML = `<div style="color:var(--red);font-size:.8rem;padding:.5rem">Error: ${esc(e.message)}</div>`;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ FULL ACTIVITY LOG ‚îÄ‚îÄ‚îÄ */
  let _allLogs = [];
  let _logFilterTimer = null;

  async function loadLog() {
    const tbody = document.getElementById('log-body');
    const countEl = document.getElementById('log-count');
    try {
      const logs = await api('activity_log?order=created_at.desc&limit=50&select=action,category,description,source,created_at');
      _allLogs = logs;
      countEl.textContent = `${logs.length} entries`;
      filterLog();
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--red);font-size:.8rem;padding:.5rem">Error: ${esc(e.message)}</td></tr>`;
    }
  }

  function scheduleLogFilter() {
    clearTimeout(_logFilterTimer);
    _logFilterTimer = setTimeout(filterLog, 200);
  }

  function filterLog() {
    const tbody = document.getElementById('log-body');
    const countEl = document.getElementById('log-count');
    const resultCountEl = document.getElementById('log-result-count');
    const query = (document.getElementById('log-search').value || '').toLowerCase().trim();
    const catFilter = document.getElementById('log-cat-filter').value;

    const filtered = _allLogs.filter(l => {
      const matchCat = !catFilter || (l.category || '').toLowerCase() === catFilter;
      const matchText = !query ||
        (l.action || '').toLowerCase().includes(query) ||
        (l.description || '').toLowerCase().includes(query);
      return matchCat && matchText;
    });

    countEl.textContent = `${_allLogs.length} entries`;
    resultCountEl.textContent = (query || catFilter)
      ? `Showing ${filtered.length} of ${_allLogs.length}`
      : '';

    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);padding:1.5rem">No matching entries</td></tr>';
      return;
    }
    tbody.innerHTML = filtered.map(l => {
      const cc = catClass(l.category || 'other');
      return `
        <tr>
          <td><span class="cat ${cc}">${esc(l.category || 'other')}</span></td>
          <td>
            <div class="log-action">${esc(l.action)}</div>
            ${l.description ? `<div class="log-desc">${esc(l.description)}</div>` : ''}
          </td>
          <td class="log-source">${esc(l.source || '‚Äî')}</td>
          <td class="log-time">${timeAgo(l.created_at)}</td>
        </tr>`;
    }).join('');
  }

  /* ‚îÄ‚îÄ‚îÄ SCOUT RESEARCH FEED ‚îÄ‚îÄ‚îÄ */
  async function loadScout() {
    const feed = document.getElementById('scout-feed');
    try {
      const msgs = await api(
        'messages?session_key=ilike.*scout*&order=created_at.desc&limit=10&select=id,session_key,channel,content,created_at'
      );

      if (!msgs.length) {
        feed.innerHTML = '<div class="scout-empty">Scout hasn\'t filed any reports yet</div>';
        return;
      }

      feed.innerHTML = msgs.map((m, i) => {
        const raw = m.content || '';
        const lines = raw.split('\n').filter(l => l.trim());
        const titleLine = lines[0] || 'Scout Report';
        // strip markdown headers
        const title = titleLine.replace(/^#+\s*/, '').replace(/\*\*/g, '').substring(0, 120);
        const previewText = raw.substring(0, 200).replace(/\n+/g, ' ');
        const hasMore = raw.length > 200;
        const id = `scout-${i}`;
        return `
          <div class="scout-card">
            <div class="scout-card-header">
              <span class="scout-title">${esc(title)}</span>
              <span class="scout-time">${timeAgo(m.created_at)}</span>
            </div>
            <div class="scout-preview" id="${id}-preview">${esc(previewText)}${hasMore ? '‚Ä¶' : ''}</div>
            <pre class="scout-full" id="${id}-full">${esc(raw)}</pre>
            ${hasMore ? `<button class="scout-expand" onclick="toggleScout('${id}')">‚ñº Show full</button>` : ''}
          </div>`;
      }).join('');
    } catch (e) {
      feed.innerHTML = `<div style="color:var(--red);font-size:.8rem;padding:.5rem">Error loading scout feed: ${esc(e.message)}</div>`;
    }
  }

  function toggleScout(id) {
    const full = document.getElementById(id + '-full');
    const preview = document.getElementById(id + '-preview');
    const btn = full.nextElementSibling;
    const isOpen = full.classList.toggle('open');
    preview.style.display = isOpen ? 'none' : '';
    if (btn) btn.textContent = isOpen ? '‚ñ≤ Collapse' : '‚ñº Show full';
  }

  /* ‚îÄ‚îÄ‚îÄ TASK QUICK-ADD ‚îÄ‚îÄ‚îÄ */
  async function quickAddTask() {
    const titleEl = document.getElementById('qa-title');
    const priorityEl = document.getElementById('qa-priority');
    const assigneeEl = document.getElementById('qa-assignee');
    const confirmEl = document.getElementById('qa-confirm');
    const title = titleEl.value.trim();
    if (!title) { titleEl.focus(); return; }

    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/kanban_tasks`, {
        method: 'POST',
        headers: {
          'apikey': KEY,
          'Authorization': `Bearer ${KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          id: crypto.randomUUID(),
          title,
          priority: priorityEl.value,
          assignee: assigneeEl.value,
          status: 'backlog'
        })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      titleEl.value = '';
      priorityEl.value = 'medium';
      assigneeEl.value = 'maverick';
      confirmEl.classList.add('show');
      setTimeout(() => confirmEl.classList.remove('show'), 2500);
      loadInbox();
    } catch (e) {
      alert('Failed to add task: ' + e.message);
    }
  }

  // Allow Enter key in title field
  document.addEventListener('DOMContentLoaded', () => {
    const titleEl = document.getElementById('qa-title');
    if (titleEl) titleEl.addEventListener('keydown', e => { if (e.key === 'Enter') quickAddTask(); });
  });

  /* ‚îÄ‚îÄ‚îÄ MAIN LOAD ‚îÄ‚îÄ‚îÄ */
  async function loadAll() {
    document.getElementById('last-refresh').textContent = 'refreshing‚Ä¶';
    await Promise.allSettled([
      loadAgents(),
      loadInbox(),
      loadKanbanSummary(),
      loadFeed(),
      loadLog(),
      loadScout()
    ]);
    document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
  }

  // Initial load + auto-refresh every 60s
  loadAll();
  setInterval(loadAll, 60000);
</script>
</body>
</html>
